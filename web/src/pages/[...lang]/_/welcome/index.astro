---
import { Section } from "@/layouts"
import { getLocaleContent } from "@/modules/i18n/content"
import locales from "./locales"
import { GridImage, getMeta, withCanvas, withSteps } from "@/modules/image/components"
import backImgPath from "./back.png?path"

import grainImg from "./grain.svg?raw"
import { Image } from "canvas"

const content = getLocaleContent(locales, Astro)
---

<Section id="welcome">
	<GridImage
		slot="back"
		src={backImgPath}
		rows={2}
		cols={8}
		preserveAspectRatio="xMidYMin slice"
		computeImg={
			withSteps(
				async (src) => {
					const scale = 0.4
					let {width, height} = await getMeta(src)
					width = (Math.round(width * scale) >> 1) << 1
					height = (Math.round(height * scale) >> 1) << 1
					return src
						.resize({
							width,
							height,
							fit: "contain",
						})
						.greyscale()
						.png({ quality: 1, compressionLevel: 9, palette: true })
				},
				withCanvas(async (ctx, cvs) => {
					// return new Promise(res => {
					// 	const i = new Image()
					// 	i.onload = () => {
					// 		// console.log("A")
					// 		// const data = ctx.getImageData(0, 0, cvs.width, cvs.height)
					// 		const data = cvs.toBuffer()
					// 		ctx.clearRect(0, 0, cvs.width, cvs.height)
					// 		// ctx.drawImage(i, 0, 0)
					// 		const pt = ctx.createPattern(i, 'repeat')
					// 		ctx.fillStyle = pt;
					// 		ctx.fillRect(0, 0, cvs.width, cvs.height)
					// 		ctx.globalCompositeOperation = 'source-out'

					// 		const i2 = new Image()
					// 		i2.onload = () => {
					// 			ctx.drawImage(i2, 0, 0)
					// 			res()
					// 		}
					// 		i2.src = data
					// 	}
					// 	i.src = "data:image/svg+xml;base64," + btoa(grainImg)
					// })

					const d = ctx.getImageData(0, 0, cvs.width, cvs.height)
					for (let i = 3; i < d.data.length; i += 4) {
						if (d.data[i] && Math.round(Math.random() * 2))
							d.data[i] = 0
					}
					ctx.putImageData(d, 0, 0)
				}),
				src => src.webp({quality: 50, alphaQuality: 0})
			)
		}
	/>

	<div class="hi">
		<p>{content.hi}</p>
		<h1>{content.iam}</h1>
		<p>{content.status}</p>
	</div>

	<div class="infos">
		<p>{content.what}</p>
	</div>

	<p class="footer">{content.easteregg}</p>

	<style lang="scss">
		@use "@/styles/layout.module.scss";

		:global(.back) {
			display: flex;
			align-items: flex-end;
			background-color: theme.$color-white;
			user-select: none;
			mask: linear-gradient(#fff 80%, transparent);

			svg {
				filter: contrast(calc(0.75 + 1 * theme.$bool-is-dark))
					brightness(calc(0.5 + (1 - theme.$bool-is-dark)));
				width: 100%;
				height: 50%;
			}
		}

		:global(#welcome) {
			display: grid;
			grid-template-areas:
				". ."
				". ."
				"a a"
				"b b"
				". f";
			clip-path: inset(0 0 0 0);
			min-height: min(100vh, layout.$window-max-width / 1.33);
		}

		.hi {
			grid-area: a;
			font-size: 1.75rem;

			h1 {
				font-size: 2em;
			}
		}

		.infos {
			grid-area: b;
			backdrop-filter: blur(0.5rem) brightness(115%);
			box-sizing: border-box;
			margin: auto;
			border: 1px solid theme.$color-dark-grey;
			border-radius: 0.5rem;
			padding: 0.75rem;
			width: 100%;
			height: fit-content;
		}

		.footer {
			grid-area: f;
			margin: auto 0 0 auto;
			color: theme.$color-black;
		}
	</style>
</Section>
